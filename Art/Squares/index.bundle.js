(()=>{"use strict";let e,t,n,i,o,a,c,s,d,l,r,u,p,m,h,v,f,w,g,b,y,E,L,k,A,I,M,x,D,S,q;function R(e){let t=e.clientX/window.innerWidth;v.placeCursor(t),C(Math.abs(255*(1-t)))}function C(e){for(let t=0;t<I.length;t+=4){let[n,i,o]=I.slice(t,t+3);.299*n+.587*i+.114*o>e?x.set([255,255,255],t):x.set([0,0,0],t)}let t=new ImageData(x,S,q);E.putImageData(t,0,0)}let T=[];function W(e,t,n=.35){let i=[];for(let n of T)j(n,e,t)?i.push(...F(n,2,2)):i.push(n);T=i}function j(e,t,n,i=.35){if(Math.random()<i)return!0;let o=[e[2]-e[0],e[3]-e[1]];if(o[0]<t||o[1]<t)return!1;let a=[E.getImageData(e[0],e[1],1,1).data[0],E.getImageData(e[2],e[1],1,1).data[0],E.getImageData(e[2],e[3],1,1).data[0],E.getImageData(e[0],e[3],1,1).data[0]];if(a[0]!=a[1]||a[1]!=a[2]||a[2]!=a[3]||a[3]!=a[0]||a[0]!=a[2]||a[1]!=a[3])return!0;let c=b.getImageData(e[0],e[1],...o).data,s=0;for(let e=0;e<c.length;e+=4)s+=c[e]+c[e+1]+c[e+2];return s/=.75*c.length,s<n}function F(e,t,n){let i=(e[2]-e[0])/t,o=(e[3]-e[1])/n,a=[];for(let c=0;c<n;c++)for(let n=0;n<t;n++)a.push([e[0]+n*i,e[1]+c*o,e[0]+(n+1)*i,e[1]+(c+1)*o]);return a}let U,H=[],P=[];async function B(){return H=[],P=[],await navigator.mediaDevices.enumerateDevices().then((e=>{for(let t of e){let e=t.getCapabilities();H.push({device:t,capabilities:e})}})).catch((e=>{H.push({})})).finally((()=>{!function(){H=H.filter((e=>null!=e.device&&"audioinput"!=e.device.kind&&null!=e.capabilities.facingMode&&0!=e.capabilities.facingMode?.length));for(let e of H){let t={deviceId:e.device.deviceId,groupId:e.device.groupId,label:e.device.label,width:e.capabilities.width,height:e.capabilities.height,facingMode:e.capabilities.facingMode};P.push(t)}}()})),P}function O(e){console.log("device selezionata: "),console.log(e),navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId,facingMode:{exact:e.facingMode}}}).then((e=>{U=e;let t=document.querySelector("video");t.addEventListener("canplay",(()=>{var e,n;e=t.videoWidth,n=t.videoHeight,S=e,q=n,f.width=S,f.height=q,g.width=S,g.height=q,y.width=S,y.height=q,y.style.left=.5*(innerWidth-S)+"px",y.style.top=.5*(innerHeight-q)+"px",L.width=S,L.height=q,L.style.left=.5*(innerWidth-S)+"px",L.style.top=.5*(innerHeight-q)+"px",L.style.display="none",V()})),t.srcObject=e,t.play()}))}const $={user:void 0,environment:void 0};async function z(){window.addEventListener("loading-widget",(function e(t){"close"==t.detail.action&&(window.removeEventListener("loading-widget",e),c.createButtons(),G())}));const e=await B();let t,n;for(let i of e)"user"==i.facingMode?t?i.width.max>t.width.max&&(t=i):t=i:"environment"==i.facingMode&&(n?i.width.max>n.width.max&&(n=i):n=i);const i=[];t&&(i.push("user"),$.user=t),n&&(i.push("environment"),$.environment=n),i.length>0?(c.setAttribute("buttons",i.join(" ")),a.hide()):(h.setText("\n\t\tWe couldn't find any usable stream on your device :(\n\t\t"),h.show())}function G(){c.show(),window.addEventListener("device-buttons",(function(e){"user"==e.detail.action&&$.user?(c.hide(),O($.user)):"environment"==e.detail.action&&$.environment&&(c.hide(),O($.environment))}))}function V(){function t(n){"close"==n.detail.action&&(window.removeEventListener("snap-button",t),window.removeEventListener("simple-button",t),w.drawImage(e,0,0,S,q),A=w.getImageData(0,0,S,q),I=new Uint8ClampedArray(A.data),M=I.slice(),x=I.slice(),D=I.slice(),function(e){for(let e=0;e<I.length;e+=4){let[t,n,i]=I.slice(e,e+3),o=.299*t+.587*n+.114*i+50;M.set([o,o,o],e)}let t=new ImageData(M,S,q);b.putImageData(t,0,0)}(),C(128),v.addEventListener("click",R),v.placeCursor(.5),s.hide(),d.hide(),X())}e.style.display="block",o.style.opacity=0,i.style.opacity=0,s.show(),d.show(),window.addEventListener("snap-button",t),window.addEventListener("simple-button",(function(n){"click"==n.detail.action&&"backToDevice"==n.detail?.type&&(null!=U&&(U.getTracks().forEach((e=>{e.stop()})),e.srcObject=null),window.removeEventListener("snap-button",t),window.removeEventListener("simple-button",t),s.hide(),d.hide(),G())}))}function X(){e.style.display="none",o.style.opacity=0,i.style.opacity=1,l.show(),r.show(),v.show(),window.addEventListener("simple-button",(function e(t){"click"==t.detail.action&&("ok"==t.detail.type?(window.removeEventListener("simple-button",e),o.style.opacity=1,i.style.opacity=0,u.show(),m.show(),window.addEventListener("simple-button",(function e(t){if("click"==t.detail.action)if("resnap"==t.detail.type)window.removeEventListener("simple-button",e),V(),u.hide(),p.hide(),m.hide();else if("cancel"==t.detail.type)window.removeEventListener("simple-button",e),X(),u.hide(),p.hide(),m.hide();else if("share"==t.detail.type){let n=L;function i(e){let t=document.createElement("a");t.setAttribute("download","CanvasAsImage.png"),e.toBlob((function(e){let n=URL.createObjectURL(e);t.setAttribute("href",n),t.click()}))}n.toBlob((e=>{const t={files:[new File([e],"squares.png",{type:"image/png"})]};navigator.share(t).then((()=>{console.log("Shared successfully"),window.confirm("Vuoi scaricare una copia?")&&i(n)}))}))}})),function(){let e=document.querySelector("video"),t=e.videoWidth,n=e.videoHeight,i=function(e,t){for(;e!=t;)e>t?e-=t:t-=e;return e}(t,n),o=Math.floor(t/i),a=Math.floor(n/i);T=[],T=F([0,0,S,q],o,a),W(10,64,.25),W(10,32,.25),W(5,32,.15),W(5,16,.15),W(4,16,.5),W(2,8,.5),L.style.display="block",function(){k.clearRect(0,0,S,q),k.fillStyle="black",k.fillRect(0,0,S,q),k.globalAlpha=.1;let e=Math.PI/326;for(let t of T){let n=Math.floor(40*Math.random()-20);for(let i=0;i<8;i++){let i=2*Math.random()*e-.5*e;k.rotate(i),k.strokeStyle=`hsl(${150+n},100%,50%)`,k.strokeRect(t[0],t[1],t[2]-t[0],t[3]-t[1]),k.rotate(-i)}}}()}(),l.hide(),r.hide(),v.hide()):"no"==t.detail.type&&(window.removeEventListener("simple-button",e),l.hide(),r.hide(),v.hide(),V()))}))}(async()=>{if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.register("./sw.js",{scope:"./"});e.installing?console.log("Service worker installing"):e.waiting?console.log("Service worker installed"):e.active&&console.log("Service worker active")}catch(e){console.error(`Registration failed with ${e}`)}})(),function(){e=document.createElement("video"),document.body.append(e);const f=document.querySelector("#canvas-container");t=document.createElement("canvas"),t.classList.add("offscreen-canvas"),f.append(t),t.id="snap-canvas",n=document.createElement("canvas"),n.classList.add("offscreen-canvas"),f.append(n),n.id="bw-canvas",i=document.createElement("canvas"),i.classList.add("offscreen-canvas"),f.append(i),i.id="thr-canvas",o=document.createElement("canvas"),o.classList.add("offscreen-canvas"),f.append(o),o.id="res-canvas",a=document.createElement("loading-widget"),a.setAttribute("time",".2"),document.body.append(a),c=document.createElement("device-buttons"),document.body.append(c),s=document.createElement("snap-button"),document.body.append(s),d=document.createElement("simple-button"),d.setAttribute("side","corner"),d.setAttribute("type","backToDevice"),document.body.append(d),r=document.createElement("simple-button"),r.setAttribute("side","left"),r.setAttribute("type","no"),document.body.append(r),l=document.createElement("simple-button"),l.setAttribute("side","right"),l.setAttribute("type","ok"),document.body.append(l),u=document.createElement("simple-button"),u.setAttribute("side","left"),u.setAttribute("type","resnap"),document.body.append(u),p=document.createElement("simple-button"),p.setAttribute("side","center"),p.setAttribute("type","cancel"),document.body.append(p),m=document.createElement("simple-button"),m.setAttribute("side","right"),m.setAttribute("type","share"),document.body.append(m),h=document.createElement("simple-caption"),document.body.append(h),v=document.createElement("simple-slider"),document.body.append(v)}(),f=document.querySelector("#snap-canvas"),w=f.getContext("2d",{willReadFrequently:!0}),g=document.querySelector("#bw-canvas"),b=g.getContext("2d",{willReadFrequently:!0}),y=document.querySelector("#thr-canvas"),E=y.getContext("2d",{willReadFrequently:!0}),L=document.querySelector("#res-canvas"),k=L.getContext("2d",{willReadFrequently:!0}),function(){let e=!1;function t(n){"close"==n.detail.action&&(e?(window.removeEventListener("simple-caption",t),setTimeout(z,500)):h.setText("\n\t\t\t\tSorry: no permission, no photo, no applications :(\n\t\t\t\t"))}a.show(),h.setText("\n\tPlease wait while we check for permission to use camera\n\t<br><br>\n\tGive permission when/if asked to use the app!\n\t"),h.show(),setTimeout((async function(){const n=await async function(){let e;return await navigator.mediaDevices.getUserMedia({video:!0}).then((t=>{console.log("Permission granted"),e=!0})).catch((t=>{e=!1,console.log("Permission not granted"),console.log(t)})),e}();e=n,window.addEventListener("simple-caption",t),h.hide()}),2e3)}()})();