(()=>{"use strict";let e,t,n,i,o,a,d,c,s,l,r,u,p,m,h,v,f,w,g,b,y,E,L,A,I,k,M,x,D,q,S;function C(e){let t=e.clientX/window.innerWidth;v.placeCursor(t),R(Math.abs(255*(1-t)))}function R(e){for(let t=0;t<k.length;t+=4){let[n,i,o]=k.slice(t,t+3);.299*n+.587*i+.114*o>e?x.set([255,255,255],t):x.set([0,0,0],t)}let t=new ImageData(x,q,S);E.putImageData(t,0,0)}let T=[];function W(e,t,n=.35){let i=[];for(let n of T)F(n,e,t)?i.push(...U(n,2,2)):i.push(n);T=i}function F(e,t,n,i=.35){if(Math.random()<i)return!0;let o=[e[2]-e[0],e[3]-e[1]];if(o[0]<t||o[1]<t)return!1;let a=[E.getImageData(e[0],e[1],1,1).data[0],E.getImageData(e[2],e[1],1,1).data[0],E.getImageData(e[2],e[3],1,1).data[0],E.getImageData(e[0],e[3],1,1).data[0]];if(a[0]!=a[1]||a[1]!=a[2]||a[2]!=a[3]||a[3]!=a[0]||a[0]!=a[2]||a[1]!=a[3])return!0;let d=b.getImageData(e[0],e[1],...o).data,c=0;for(let e=0;e<d.length;e+=4)c+=d[e]+d[e+1]+d[e+2];return c/=.75*d.length,c<n}function U(e,t,n){let i=(e[2]-e[0])/t,o=(e[3]-e[1])/n,a=[];for(let d=0;d<n;d++)for(let n=0;n<t;n++)a.push([e[0]+n*i,e[1]+d*o,e[0]+(n+1)*i,e[1]+(d+1)*o]);return a}let j,H=[],P=[];async function B(){return H=[],P=[],await navigator.mediaDevices.enumerateDevices().then((e=>{for(let t of e){let e=t.getCapabilities();H.push({device:t,capabilities:e})}})).catch((e=>{H.push({})})).finally((()=>{!function(){H=H.filter((e=>null!=e.device&&"audioinput"!=e.device.kind&&null!=e.capabilities.facingMode&&0!=e.capabilities.facingMode?.length));for(let e of H){let t={deviceId:e.device.deviceId,groupId:e.device.groupId,label:e.device.label,width:e.capabilities.width,height:e.capabilities.height,facingMode:e.capabilities.facingMode};P.push(t)}}()})),P}function O(e){console.log("device selezionata: "),console.log(e),navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId,facingMode:{exact:e.facingMode}}}).then((e=>{j=e;let t=document.querySelector("video");t.addEventListener("canplay",(()=>{var e,n;e=t.videoWidth,n=t.videoHeight,q=e,S=n,f.width=q,f.height=S,g.width=q,g.height=S,y.width=q,y.height=S,y.style.left=.5*(innerWidth-q)+"px",y.style.top=.5*(innerHeight-S)+"px",L.width=q,L.height=S,L.style.left=.5*(innerWidth-q)+"px",L.style.top=.5*(innerHeight-S)+"px",L.style.display="none",X()})),t.srcObject=e,t.play()}))}const z={user:void 0,environment:void 0};async function G(){window.addEventListener("loading-widget",(function e(t){"close"==t.detail.action&&(window.removeEventListener("loading-widget",e),d.createButtons(),V())}));const e=await B();let t,n;for(let i of e)"user"==i.facingMode?t?i.width.max>t.width.max&&(t=i):t=i:"environment"==i.facingMode&&(n?i.width.max>n.width.max&&(n=i):n=i);const i=[];t&&(i.push("user"),z.user=t),n&&(i.push("environment"),z.environment=n),i.length>0?(d.setAttribute("buttons",i.join(" ")),a.hide()):(h.setText("\n\t\tWe couldn't find any usable stream on your device :(\n\t\t"),h.show())}function V(){d.show(),window.addEventListener("device-buttons",(function(e){"user"==e.detail.action&&z.user?(d.hide(),O(z.user)):"environment"==e.detail.action&&z.environment&&(d.hide(),O(z.environment))}))}function X(){function t(n){"close"==n.detail.action&&(window.removeEventListener("snap-button",t),window.removeEventListener("simple-button",t),w.drawImage(e,0,0,q,S),I=w.getImageData(0,0,q,S),k=new Uint8ClampedArray(I.data),M=k.slice(),x=k.slice(),D=k.slice(),function(e){for(let e=0;e<k.length;e+=4){let[t,n,i]=k.slice(e,e+3),o=.299*t+.587*n+.114*i+50;M.set([o,o,o],e)}let t=new ImageData(M,q,S);b.putImageData(t,0,0)}(),R(128),v.addEventListener("click",C),v.placeCursor(.5),c.hide(),s.hide(),$())}e.style.display="block",o.style.opacity=0,i.style.opacity=0,c.show(),s.show(),window.addEventListener("snap-button",t),window.addEventListener("simple-button",(function(n){"click"==n.detail.action&&"backToDevice"==n.detail?.type&&(null!=j&&(j.getTracks().forEach((e=>{e.stop()})),e.srcObject=null),window.removeEventListener("snap-button",t),window.removeEventListener("simple-button",t),c.hide(),s.hide(),V())}))}function $(){e.style.display="none",o.style.opacity=0,i.style.opacity=1,l.show(),r.show(),v.show(),window.addEventListener("simple-button",(function e(t){"click"==t.detail.action&&("ok"==t.detail.type?(window.removeEventListener("simple-button",e),o.style.opacity=1,i.style.opacity=0,u.show(),m.show(),window.addEventListener("simple-button",(function e(t){if("click"==t.detail.action)if("resnap"==t.detail.type)window.removeEventListener("simple-button",e),X(),u.hide(),p.hide(),m.hide();else if("cancel"==t.detail.type)window.removeEventListener("simple-button",e),$(),u.hide(),p.hide(),m.hide();else if("share"==t.detail.type){let n=L;function i(e){let t=document.createElement("a");t.setAttribute("download","CanvasAsImage.png"),e.toBlob((function(e){let n=URL.createObjectURL(e);t.setAttribute("href",n),t.click()}))}n.toBlob((e=>{const t={files:[new File([e],"squares.png",{type:"image/png"})]};navigator.share(t).then((()=>{console.log("Shared successfully"),window.confirm("Vuoi scaricare una copia?")&&i(n)}))}))}})),function(){let e=document.querySelector("video"),t=e.videoWidth,n=e.videoHeight,i=function(e,t){for(;e!=t;)e>t?e-=t:t-=e;return e}(t,n),o=Math.floor(t/i),a=Math.floor(n/i);T=[],T=U([0,0,q,S],o,a),W(10,64,.25),W(10,32,.25),W(5,32,.15),W(5,16,.15),W(4,16,.5),W(2,8,.5),L.style.display="block",function(){A.clearRect(0,0,q,S),A.fillStyle="black",A.fillRect(0,0,q,S),A.globalAlpha=.1;let e=Math.PI/326;for(let t of T){let n=Math.floor(40*Math.random()-20);for(let i=0;i<8;i++){let i=2*Math.random()*e-.5*e;A.rotate(i),A.strokeStyle=`hsl(${150+n},100%,50%)`,A.strokeRect(t[0],t[1],t[2]-t[0],t[3]-t[1]),A.rotate(-i)}}}()}(),l.hide(),r.hide(),v.hide()):"no"==t.detail.type&&(window.removeEventListener("simple-button",e),l.hide(),r.hide(),v.hide(),X()))}))}!function(){e=document.createElement("video"),document.body.append(e);const f=document.querySelector("#canvas-container");t=document.createElement("canvas"),t.classList.add("offscreen-canvas"),f.append(t),t.id="snap-canvas",n=document.createElement("canvas"),n.classList.add("offscreen-canvas"),f.append(n),n.id="bw-canvas",i=document.createElement("canvas"),i.classList.add("offscreen-canvas"),f.append(i),i.id="thr-canvas",o=document.createElement("canvas"),o.classList.add("offscreen-canvas"),f.append(o),o.id="res-canvas",a=document.createElement("loading-widget"),a.setAttribute("time",".2"),document.body.append(a),d=document.createElement("device-buttons"),document.body.append(d),c=document.createElement("snap-button"),document.body.append(c),s=document.createElement("simple-button"),s.setAttribute("side","corner"),s.setAttribute("type","backToDevice"),document.body.append(s),r=document.createElement("simple-button"),r.setAttribute("side","left"),r.setAttribute("type","no"),document.body.append(r),l=document.createElement("simple-button"),l.setAttribute("side","right"),l.setAttribute("type","ok"),document.body.append(l),u=document.createElement("simple-button"),u.setAttribute("side","left"),u.setAttribute("type","resnap"),document.body.append(u),p=document.createElement("simple-button"),p.setAttribute("side","center"),p.setAttribute("type","cancel"),document.body.append(p),m=document.createElement("simple-button"),m.setAttribute("side","right"),m.setAttribute("type","share"),document.body.append(m),h=document.createElement("simple-caption"),document.body.append(h),v=document.createElement("simple-slider"),document.body.append(v)}(),f=document.querySelector("#snap-canvas"),w=f.getContext("2d",{willReadFrequently:!0}),g=document.querySelector("#bw-canvas"),b=g.getContext("2d",{willReadFrequently:!0}),y=document.querySelector("#thr-canvas"),E=y.getContext("2d",{willReadFrequently:!0}),L=document.querySelector("#res-canvas"),A=L.getContext("2d",{willReadFrequently:!0}),function(){let e=!1;function t(n){"close"==n.detail.action&&(e?(window.removeEventListener("simple-caption",t),setTimeout(G,500)):h.setText("\n\t\t\t\tSorry: no permission, no photo, no applications :(\n\t\t\t\t"))}a.show(),h.setText("\n\tPlease wait while we check for permission to use camera\n\t<br><br>\n\tGive permission when/if asked to use the app!\n\t"),h.show(),setTimeout((async function(){const n=await async function(){let e;return await navigator.mediaDevices.getUserMedia({video:!0}).then((t=>{console.log("Permission granted"),e=!0})).catch((t=>{e=!1,console.log("Permission not granted"),console.log(t)})),e}();e=n,window.addEventListener("simple-caption",t),h.hide()}),2e3)}()})();