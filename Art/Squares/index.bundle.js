(()=>{"use strict";let e,t,n,i,a,o,d,s,c,l,r,u,p,m,h,v,g,w,f,y,b,E,L,I,D,M,k,x,A,q,S;function C(e){let t=e.clientX/window.innerWidth;v.placeCursor(t),T(Math.abs(255*(1-t)))}function T(e){for(let t=0;t<M.length;t+=4){let[n,i,a]=M.slice(t,t+3);.299*n+.587*i+.114*a>e?x.set([255,255,255],t):x.set([0,0,0],t)}let t=new ImageData(x,q,S);E.putImageData(t,0,0)}let R=[];function W(e,t,n=.35){let i=[];for(let n of R)F(n,e,t)?i.push(...H(n,2,2)):i.push(n);R=i}function F(e,t,n,i=.35){if(Math.random()<i)return!0;let a=[e[2]-e[0],e[3]-e[1]];if(a[0]<t||a[1]<t)return!1;let o=[E.getImageData(e[0],e[1],1,1).data[0],E.getImageData(e[2],e[1],1,1).data[0],E.getImageData(e[2],e[3],1,1).data[0],E.getImageData(e[0],e[3],1,1).data[0]];if(o[0]!=o[1]||o[1]!=o[2]||o[2]!=o[3]||o[3]!=o[0]||o[0]!=o[2]||o[1]!=o[3])return!0;let d=y.getImageData(e[0],e[1],...a).data,s=0;for(let e=0;e<d.length;e+=4)s+=d[e]+d[e+1]+d[e+2];return s/=.75*d.length,s<n}function H(e,t,n){let i=(e[2]-e[0])/t,a=(e[3]-e[1])/n,o=[];for(let d=0;d<n;d++)for(let n=0;n<t;n++)o.push([e[0]+n*i,e[1]+d*a,e[0]+(n+1)*i,e[1]+(d+1)*a]);return o}let P,j=[],U=[];async function B(){return j=[],U=[],await navigator.mediaDevices.enumerateDevices().then((e=>{for(let t of e){let e=t.getCapabilities();j.push({device:t,capabilities:e})}})).catch((e=>{j.push({})})).finally((()=>{!function(){j=j.filter((e=>null!=e.device&&"audioinput"!=e.device.kind&&null!=e.capabilities.facingMode&&0!=e.capabilities.facingMode?.length));for(let e of j){let t={deviceId:e.device.deviceId,groupId:e.device.groupId,label:e.device.label,width:e.capabilities.width,height:e.capabilities.height,facingMode:e.capabilities.facingMode};U.push(t)}}()})),U}function O(e){console.log("device selezionata: "),console.log(e),navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId,facingMode:{exact:e.facingMode}}}).then((e=>{P=e;let t=document.querySelector("video");t.addEventListener("canplay",(()=>{var e,n;e=t.videoWidth,n=t.videoHeight,q=e,S=n,g.width=q,g.height=S,f.width=q,f.height=S,b.width=q,b.height=S,b.style.left=.5*(innerWidth-q)+"px",b.style.top=.5*(innerHeight-S)+"px",L.width=q,L.height=S,L.style.left=.5*(innerWidth-q)+"px",L.style.top=.5*(innerHeight-S)+"px",L.style.display="none",$()})),t.srcObject=e,t.play()}))}const z={user:void 0,environment:void 0};async function G(){window.addEventListener("loading-widget",(function e(t){"close"==t.detail.action&&(window.removeEventListener("loading-widget",e),d.createButtons(),X())}));const e=await B();let t,n;for(let i of e)"user"==i.facingMode?t?i.width.max>t.width.max&&(t=i):t=i:"environment"==i.facingMode&&(n?i.width.max>n.width.max&&(n=i):n=i);const i=[];t&&(i.push("user"),z.user=t),n&&(i.push("environment"),z.environment=n),i.length>0?(d.setAttribute("buttons",i.join(" ")),o.hide()):(h.setText("\n\t\tWe couldn't find any usable stream on your device :(\n\t\t"),h.show())}function X(){d.show(),window.addEventListener("device-buttons",(function(e){"user"==e.detail.action&&z.user?(d.hide(),O(z.user)):"environment"==e.detail.action&&z.environment&&(d.hide(),O(z.environment))}))}function $(){function t(n){"close"==n.detail.action&&(window.removeEventListener("snap-button",t),window.removeEventListener("simple-button",t),w.drawImage(e,0,0,q,S),D=w.getImageData(0,0,q,S),M=new Uint8ClampedArray(D.data),k=M.slice(),x=M.slice(),A=M.slice(),function(e){for(let e=0;e<M.length;e+=4){let[t,n,i]=M.slice(e,e+3),a=.299*t+.587*n+.114*i+50;k.set([a,a,a],e)}let t=new ImageData(k,q,S);y.putImageData(t,0,0)}(),T(128),v.addEventListener("click",C),v.placeCursor(.5),s.hide(),c.hide(),J())}e.style.display="block",a.style.opacity=0,i.style.opacity=0,s.show(),c.show(),window.addEventListener("snap-button",t),window.addEventListener("simple-button",(function(n){"click"==n.detail.action&&"backToDevice"==n.detail?.type&&(null!=P&&(P.getTracks().forEach((e=>{e.stop()})),e.srcObject=null),window.removeEventListener("snap-button",t),window.removeEventListener("simple-button",t),s.hide(),c.hide(),X())}))}function J(){e.style.display="none",a.style.opacity=0,i.style.opacity=1,l.show(),r.show(),v.show(),window.addEventListener("simple-button",(function e(t){"click"==t.detail.action&&("ok"==t.detail.type?(window.removeEventListener("simple-button",e),a.style.opacity=1,i.style.opacity=0,u.show(),m.show(),window.addEventListener("simple-button",(function e(t){"click"==t.detail.action&&("resnap"==t.detail.type?(window.removeEventListener("simple-button",e),$(),u.hide(),p.hide(),m.hide()):"cancel"==t.detail.type?(window.removeEventListener("simple-button",e),J(),u.hide(),p.hide(),m.hide()):"share"==t.detail.type&&a.toBlob((e=>{const t={files:[new File([e],"squares.png",{type:"image/png"})]};navigator.share(t).then((()=>{console.log("Shared successfully")}))})))})),function(){let e=document.querySelector("video"),t=e.videoWidth,n=e.videoHeight,i=function(e,t){for(;e!=t;)e>t?e-=t:t-=e;return e}(t,n),a=Math.floor(t/i),o=Math.floor(n/i);R=H([0,0,q,S],a,o),W(10,64,.25),W(10,32,.25),W(5,32,.15),W(5,16,.15),W(4,16,.5),W(2,8,.5),L.style.display="block",function(){I.fillStyle="black",I.fillRect(0,0,q,S),I.globalAlpha=.1;let e=Math.PI/326;for(let t of R){let n=Math.floor(40*Math.random()-20);for(let i=0;i<8;i++){let i=2*Math.random()*e-.5*e;I.rotate(i),I.strokeStyle=`hsl(${150+n},100%,50%)`,I.strokeRect(t[0],t[1],t[2]-t[0],t[3]-t[1]),I.rotate(-i)}}!function(){let e=w.getImageData(0,0,g.width,g.height).data,t=I.getImageData(0,0,L.width,L.height).data,n=new ImageData(L.width,L.height);for(let i=0;i<e.length;i+=4){let a=[240&t[i],240&t[i+1],240&t[i+2]],o=[(240&e[i])>>4,(240&e[i+1])>>4,(240&e[i+2])>>4];n.data.set([a[0]+o[0],a[1]+o[1],a[2]+o[2],255],i)}I.putImageData(n,0,0)}()}()}(),l.hide(),r.hide(),v.hide()):"no"==t.detail.type&&(window.removeEventListener("simple-button",e),l.hide(),r.hide(),v.hide(),$()))}))}!function(){e=document.createElement("video"),document.body.append(e);const g=document.querySelector("#canvas-container");t=document.createElement("canvas"),t.classList.add("offscreen-canvas"),g.append(t),t.id="snap-canvas",n=document.createElement("canvas"),n.classList.add("offscreen-canvas"),g.append(n),n.id="bw-canvas",i=document.createElement("canvas"),i.classList.add("offscreen-canvas"),g.append(i),i.id="thr-canvas",a=document.createElement("canvas"),a.classList.add("offscreen-canvas"),g.append(a),a.id="res-canvas",o=document.createElement("loading-widget"),o.setAttribute("time",".2"),document.body.append(o),d=document.createElement("device-buttons"),document.body.append(d),s=document.createElement("snap-button"),document.body.append(s),c=document.createElement("simple-button"),c.setAttribute("side","corner"),c.setAttribute("type","backToDevice"),document.body.append(c),r=document.createElement("simple-button"),r.setAttribute("side","left"),r.setAttribute("type","no"),document.body.append(r),l=document.createElement("simple-button"),l.setAttribute("side","right"),l.setAttribute("type","ok"),document.body.append(l),u=document.createElement("simple-button"),u.setAttribute("side","left"),u.setAttribute("type","resnap"),document.body.append(u),p=document.createElement("simple-button"),p.setAttribute("side","center"),p.setAttribute("type","cancel"),document.body.append(p),m=document.createElement("simple-button"),m.setAttribute("side","right"),m.setAttribute("type","share"),document.body.append(m),h=document.createElement("simple-caption"),document.body.append(h),v=document.createElement("simple-slider"),document.body.append(v)}(),g=document.querySelector("#snap-canvas"),w=g.getContext("2d",{willReadFrequently:!0}),f=document.querySelector("#bw-canvas"),y=f.getContext("2d",{willReadFrequently:!0}),b=document.querySelector("#thr-canvas"),E=b.getContext("2d",{willReadFrequently:!0}),L=document.querySelector("#res-canvas"),I=L.getContext("2d",{willReadFrequently:!0}),function(){let e=!1;function t(n){"close"==n.detail.action&&(e?(window.removeEventListener("simple-caption",t),setTimeout(G,500)):h.setText("\n\t\t\t\tSorry: no permission, no photo, no applications :(\n\t\t\t\t"))}o.show(),h.setText("\n\tPlease wait while we check for permission to use camera\n\t<br><br>\n\tGive permission when/if asked to use the app!\n\t"),h.show(),setTimeout((async function(){const n=await async function(){let e;return await navigator.mediaDevices.getUserMedia({video:!0}).then((t=>{console.log("Permission granted"),e=!0})).catch((t=>{e=!1,console.log("Permission not granted"),console.log(t)})),e}();e=n,window.addEventListener("simple-caption",t),h.hide()}),2e3)}()})();